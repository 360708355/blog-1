{"tags":[{"name":"oracle","permalink":"http://lingyucoder.github.io/tags/oracle/","url":"/async/tags/oracle.json","count":1},{"name":"存储函数","permalink":"http://lingyucoder.github.io/tags/存储函数/","url":"/async/tags/存储函数.json","count":1}],"categories":[{"name":"数据库","permalink":"http://lingyucoder.github.io/categories/数据库/","url":"/async/categories/数据库.json","count":1}],"url":"/async/posts/2014/02/19/plsql-and-storage-function.json","date":1392739200000,"path":{"year":2014,"month":2,"day":19,"name":"plsql-and-storage-function"},"subtitle":"PL/SQL安装使用 + 简单的存储函数编写","title":"PL/SQL编写存储函数","permalink":"http://lingyucoder.github.io/2014/02/19/plsql-and-storage-function/","content":"<p>在编写报表的时候经常会遇到数据结构不适合生成交叉报表或列式报表的情况，而生成报表的报表工具又没有强力到能够将数据转换成理想的格式。但公司的数据库是用Oracle，还是可以使用PL/SQL来对数据进行转换。这里介绍了PL/SQL安装使用以及简单的存储函数的编写</p>\n<a id=\"more\"></a>\n<h2 id=\"PL/SQL安装\">PL/SQL安装</h2><hr>\n<p><a href=\"http://pan.baidu.com/s/1ntwisrB\" target=\"_blank\" rel=\"external\">PL/SQL和Oracle920整合的压缩包</a><br>提取码：cgsf</p>\n<p>下载后由”PL_SQL_DEV_9 + Oracle920.rar”解压并安装</p>\n<h3 id=\"安装Oracle920\">安装Oracle920</h3><ol>\n<li>解压压缩包，建议将Oracle920文件夹放在D盘根目录下，否则需要修改其注册表文件中的路径</li>\n<li>运行注册表文件oracle.reg</li>\n<li>在环境变量中添加bin文件夹路径，如放在D盘根目录下，则添加D:\\oracle920\\bin</li>\n</ol>\n<h3 id=\"安装pl/sql\">安装pl/sql</h3><ol>\n<li>解压压缩包</li>\n<li>运行plsqldev906.exe安装</li>\n<li>运行chinese.exe添加中文补丁</li>\n</ol>\n<h3 id=\"注意事项\">注意事项</h3><ol>\n<li>若Oracle920路径不放在D盘根目录下，运行注册表文件oracle.reg文件前，用文本编辑工具打开，将所有涉及路径的地方修改成Oracle920文件夹的路径</li>\n<li>请在32位机上安装，64位自行百度解决方法</li>\n</ol>\n<h3 id=\"修改pl/sql登录时的服务器可选项\">修改pl/sql登录时的服务器可选项</h3><p>由于无锡、绥化的Oracle服务器IP地址出现变更，需要修改服务器地址</p>\n<p>存放地址的文件为(Oracle920所在文件夹)/Oracle920/network/ADMIN/tnsnames.ora，使用文本编辑工具打开</p>\n<p>可以看到其中有类似代码：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hiservice_197 =&#10;  (DESCRIPTION =&#10;    (ADDRESS_LIST =&#10;      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.197)(PORT = 1521))&#10;    )&#10;    (CONNECT_DATA =&#10;      (SID = hiservic)&#10;    )&#10;  )</span><br></pre></td></tr></table></figure></p>\n<p>其中<figure class=\"highlight\"><figcaption><span>= 192.168.0.197```定义了IP地址，```PORT = 1521```定义了端口，```SID = hiservic```定义了连接的数据库，可以根据需要进行修改，或者按照同样的规则在文档最后进行添加</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;##PL/SQL&#20351;&#29992;&#10;###&#19968;&#33324;CRUD&#25805;&#20316;&#10;&#24456;&#31616;&#21333;&#65292;&#22312;&#33756;&#21333; &#25991;&#20214;-&#62;&#26032;&#24314;-&#62;SQL&#31383;&#21475; &#26469;&#21019;&#24314;&#26032;&#30340;SQL&#31383;&#21475;&#65292;&#22312;&#31383;&#21475;&#20013;&#25970;&#20837;SQL&#35821;&#21477;&#65292;&#25353;F8&#25191;&#34892;&#10;&#10;&#33509;&#35201;&#36890;&#36807;&#22270;&#24418;&#30028;&#38754;&#36827;&#34892;&#26032;&#22686;&#12289;&#20462;&#25913;&#12289;&#21024;&#38500;&#65292;&#35831;&#22312;SQL&#35821;&#21477;&#21518;&#22686;&#21152;```for update```&#20195;&#30721;&#65292;&#27604;&#22914;&#21407;&#35821;&#21477;&#20026;```select * from user_info```&#65292;&#21017;&#20462;&#25913;&#20026;```select * from user_info for update```&#12290;&#10;&#10;&#22312;&#25191;&#34892;&#21069;&#65292;&#28857;&#20987;SQL&#26694;&#19979;&#30340;&#8220;&#23567;&#38145;&#8221;&#24320;&#21551;&#22686;&#21152;&#12289;&#21024;&#38500;&#12289;&#20462;&#25913;&#26435;&#38480;&#65292;&#20351;&#29992;&#8220;&#23567;&#38145;&#8221;&#26049;&#36793;&#30340;&#8220;&#21152;&#21495;&#8221;&#21644;&#8220;&#20943;&#21495;&#8221;&#26469;&#26032;&#22686;&#21024;&#38500;&#25968;&#25454;&#65292;&#20462;&#25913;&#30452;&#25509;&#21333;&#20987;&#38656;&#35201;&#20462;&#25913;&#30340;&#25968;&#25454;&#26684;&#21363;&#21487;&#12290;&#10;&#10;&#20462;&#25913;&#23436;&#25104;&#21518;&#28857;&#20987;&#19968;&#19979;&#26049;&#36793;&#30340;&#8220;&#32511;&#21246;&#8221;&#30830;&#35748;&#65292;&#28982;&#21518;&#28857;&#20987;&#24038;&#19978;&#35282;&#20027;&#33756;&#21333;&#19979;&#30340;&#8220;&#25552;&#20132;&#25353;&#38062;&#8221;&#25110;&#25353;F10&#36827;&#34892;&#25552;&#20132;&#65292;&#21542;&#21017;&#20107;&#21153;&#19981;&#20250;&#25552;&#20132;&#65292;&#20462;&#25913;&#19981;&#20250;&#29983;&#25928;&#10;&#10;###&#23384;&#20648;&#36807;&#31243;&#30456;&#20851;&#10;&#22312;&#26377;&#21451;&#22909;&#25554;&#20214;&#30340;&#25991;&#26412;&#32534;&#36753;&#24037;&#20855;&#20013;&#20889;&#23436;&#23384;&#20648;&#36807;&#31243;&#21518;&#65292;&#33509;&#35201;&#20840;&#37096;&#25191;&#34892;&#65292;&#21487;&#20197;&#30452;&#25509;&#22797;&#21046;&#21040;&#21516;&#19978;&#30340;SQL&#26694;&#10;&#10;&#22914;&#38656;&#19968;&#20010;&#19968;&#20010;&#23450;&#20041;&#25191;&#34892;&#65292;&#21487;&#20197;&#22312;&#33756;&#21333; &#25991;&#20214;-&#62;&#26032;&#24314;-&#62;&#21629;&#20196;&#31383;&#21475; &#26469;&#21019;&#24314;&#21629;&#20196;&#34892;&#65292;&#28982;&#21518;&#36890;&#36807;&#22797;&#21046;&#20195;&#30721;&#30340;&#26041;&#24335;&#20889;&#20837;&#23384;&#20648;&#36807;&#31243;&#30340;&#32467;&#26500;&#21644;&#20989;&#25968;&#65292;&#26368;&#21518;&#19968;&#34892;&#21152;```/```&#26469;&#26631;&#24535;&#32467;&#26463;&#12290;&#22312;&#21629;&#20196;&#34892;&#20013;&#38656;&#35201;&#26816;&#27979;&#26159;&#21542;&#21547;&#26377;&#26576;&#32467;&#26500;&#25110;&#20989;&#25968;&#65292;&#21487;&#20197;&#20351;&#29992;```desc```&#36827;&#34892;&#26597;&#30475;&#65292;&#22914;&#26816;&#27979;&#26576;Object&#32467;&#26500;&#25110;Table&#32467;&#26500;&#26159;&#21542;&#23384;&#22312;&#65292;&#21487;&#20197;&#20351;&#29992;&#65288;xxxx&#20026;&#32467;&#26500;&#21517;&#65289;&#65306;&#10;```sql&#10;desc type xxxx</span><br></pre></td></tr></table></figure></p>\n<p>若要检测函数或表信息，则（xxxx为函数名或表名）：<br><figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">desc xxxx</span><br></pre></td></tr></table></figure></p>\n<p>若需要检查编译错误，在菜单  文件-&gt;新建-&gt;程序窗口 来进行调试，比如存储函数，可以新建Function窗口，模板向导若已有代码，可以不必填写，点击确定后直接用已有代码进行覆盖即可。使用F8来编译，若编译错误，底下会显示编译错误的原因及产生错误的行数</p>\n<p>若存储过程中有输出语句如<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;##&#19968;&#20123;&#23384;&#20648;&#20989;&#25968;&#23454;&#20363;&#10;###&#23450;&#20041;&#20803;&#25968;&#25454;&#32467;&#26500;&#10;&#19968;&#33324;&#20351;&#29992;&#23384;&#20648;&#20989;&#25968;&#37117;&#26159;&#20026;&#20102;&#23558;&#29616;&#26377;&#30340;&#25968;&#25454;&#24211;&#34920;&#20013;&#30340;&#19981;&#35268;&#21017;&#30340;&#25968;&#25454;&#25972;&#29702;&#65292;&#29983;&#25104;iReport&#27604;&#36739;&#23481;&#26131;&#29983;&#25104;&#25253;&#34920;&#30340;&#32467;&#26500;&#12290;&#25152;&#20197;&#39318;&#20808;&#38656;&#35201;&#23450;&#20041;&#25253;&#34920;&#20013;&#38656;&#35201;&#30340;&#27599;&#19968;&#26465;&#25968;&#25454;&#30340;&#26679;&#24335;&#65306;&#10;```sql&#10;CREATE OR REPLACE TYPE objectName AS OBJECT (&#10;    property_name_1 varchar2(255),&#10;    property_name_2 number&#10;);</span><br></pre></td></tr></table></figure></p>\n<p>其中<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;&#36825;&#26679;&#23601;&#23450;&#20041;&#20102;&#19968;&#20010;&#31616;&#21333;&#30340;&#26377;&#19968;&#20010;&#23383;&#31526;&#20018;&#23646;&#24615;&#65292;&#19968;&#20010;&#25968;&#23383;&#23646;&#24615;&#30340;&#20803;&#25968;&#25454;&#32467;&#26500;&#12290;&#10;###&#23450;&#20041;&#20020;&#26102;&#34920;&#32467;&#26500;&#10;&#30001;&#20110;&#19968;&#33324;&#24773;&#20917;&#19979;&#37117;&#38656;&#35201;&#23384;&#20648;&#20989;&#25968;&#36755;&#20986;&#19968;&#25972;&#24352;&#27599;&#34892;&#37117;&#26159;&#36825;&#20010;&#32467;&#26500;&#30340;&#34920;&#65292;&#25152;&#20197;&#38656;&#35201;&#23450;&#20041;&#36890;&#36807;&#36825;&#20010;&#20803;&#25968;&#25454;&#32467;&#26500;&#32452;&#32455;&#25104;&#30340;&#34920;&#32467;&#26500;&#65306;&#10;```sql&#10;create or replace type tableName table of objectName;</span><br></pre></td></tr></table></figure></p>\n<p>其中<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">###&#23450;&#20041;&#23384;&#20648;&#20989;&#25968;&#10;&#23450;&#20041;&#23384;&#20648;&#20989;&#25968;&#65306;&#10;```sql&#10;create or replace function functionName(param1 number, param2 number)&#10;return tableName pipelined&#10;as&#10;v_row objectName;&#10;--&#21464;&#37327;&#23450;&#20041;&#10;begin&#10;--&#20989;&#25968;&#20307;&#10;return;&#10;end;</span><br></pre></td></tr></table></figure></p>\n<p>其中<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;&#38656;&#35201;&#27880;&#24847;&#21464;&#37327;&#23450;&#20041;&#37096;&#20998;&#65292;&#25152;&#26377;&#21518;&#38754;&#20351;&#29992;&#21040;&#30340;&#21464;&#37327;&#37117;&#38656;&#35201;&#22312;&#36825;&#37324;&#20808;&#34892;&#23450;&#20041;&#10;&#10;&#36825;&#20010;&#20989;&#25968;&#20013;&#23450;&#20041;&#20102;&#20004;&#20010;&#21442;&#25968;```param1```&#21644;```param2```&#65292;&#33509;&#19981;&#38656;&#35201;&#20351;&#29992;&#21442;&#25968;&#65292;&#21017;&#31532;&#19968;&#34892;&#30452;&#25509;&#25913;&#20026;```create or replace function functionName```&#65292;&#20989;&#25968;&#21517;&#21518;&#19981;&#38656;&#35201;&#28155;&#21152;&#25324;&#21495;&#10;###&#36941;&#21382;&#25968;&#25454;&#24211;&#20013;&#34920;&#33719;&#21462;&#25968;&#25454;&#10;&#22312;&#20989;&#25968;&#20307;&#20013;&#36890;&#36807;```for in```&#36941;&#21382;&#24050;&#26377;&#30340;&#34920;&#65306;</span><br></pre></td></tr></table></figure></p>\n<p>for itemName in (<br>    —sql语句<br>) loop<br>    —对表每一行数据进行操作<br>end loop;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#36825;&#37324;sql&#35821;&#21477;&#21644;&#24179;&#24120;&#30340;sql&#35821;&#21477;&#27809;&#26377;&#22826;&#22823;&#21306;&#21035;&#65292;&#21807;&#19968;&#30340;&#21306;&#21035;&#26159;&#21487;&#20197;&#20351;&#29992;&#21464;&#37327;&#20316;&#20026;```where```&#20013;&#30340;&#21028;&#26029;&#26465;&#20214;&#30340;&#21442;&#25968;&#65292;&#22914;&#26377;&#20004;&#20010;number&#22411;&#21464;&#37327;startTime&#65292;endTime&#65292;&#21487;&#20197;&#30452;&#25509;&#20351;&#29992;&#35821;&#21477;```where fieldName &#60; endTime and fieldName &#62;= startTime</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"将单个结果输出到变量\">将单个结果输出到变量</h3><p>有的时候只需要一个统计结果，通过sql的聚集函数来实现，若需要将其结果存入变量中，可以使用<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">```sql&#10;select count(someUtTableName.id) into v_number_type_var&#10;from someUtTableName&#10;where balabala</span><br></pre></td></tr></table></figure></p>\n<p>这样就将count的结果存入到名叫<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;###&#23558;&#25968;&#25454;&#32452;&#32455;&#25104;&#34920;&#10;&#33509;&#38656;&#35201;&#23558;&#25968;&#25454;&#32452;&#32455;&#25104;&#32467;&#26500;&#65292;&#28155;&#21152;&#21040;&#36820;&#22238;&#34920;&#20013;&#65306;&#10;```sql&#10;v_row := objectName(&#39;abc&#39;, 123);&#10;pip row(v_row);</span><br></pre></td></tr></table></figure></p>\n<p>其中<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;###&#22312;&#20989;&#25968;&#20013;&#22686;&#21152;&#35843;&#35797;&#29992;&#30340;&#36755;&#20986;&#10;&#22312;&#20989;&#25968;&#20307;&#20013;&#21152;&#20837;&#22914;&#19979;&#20195;&#30721;:&#10;```sql&#10;DBMS_OUTPUT.PUTLINE(&#39;test information&#39;);</span><br></pre></td></tr></table></figure></p>\n<p>即可在运行的时候产生输出，括号内可以使用变量。在SQL框的输出标签页查看输出结果</p>\n<h3 id=\"注释\">注释</h3><p>使用<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#10;&#20351;&#29992;```/*&#27880;&#37322;&#20869;&#23481;*/```&#26469;&#28155;&#21152;&#22810;&#34892;&#27880;&#37322;&#10;&#10;###&#35843;&#29992;&#23384;&#20648;&#20989;&#25968;&#10;&#24050;&#32463;&#20889;&#22909;&#30340;&#23384;&#20648;&#20989;&#25968;&#38656;&#35201;&#22312;sql&#20013;&#36827;&#34892;&#35843;&#29992;&#65292;&#22312;&#20889;&#20837;iReport&#20043;&#21069;&#21487;&#20197;&#20808;&#22312;pl/sql&#20013;&#27979;&#35797;&#19968;&#19979;&#65292;&#27604;&#22914;&#24050;&#26377;&#23384;&#20648;&#20989;&#25968;functionName&#65292;&#25509;&#21463;&#20004;&#20010;number&#21442;&#25968;&#65292;&#21017;&#65306;&#10;```sql&#10;select * from table(functionName(123, 456))</span><br></pre></td></tr></table></figure></p>\n<p>若无参数，直接<code>from table(functionName())</code>即可。将其当做一张表来看，可以使用<code>group by</code>、<code>order by</code>、<code>where</code>等。select也可以选择需要的字段或改名</p>\n"}