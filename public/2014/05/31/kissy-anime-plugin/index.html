<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="author" content="天镶"><meta name="description"><title>如何写一个KISSY动画插件 | 天镶的博客</title><link href="/favicon.png" rel="icon"><link rel="stylesheet" media="screen" href="/stylesheets/plugins/typo/typo-1.1.css"><link rel="stylesheet" media="screen" href="/stylesheets/plugins/highlight/highlight-8.0-dark.css"><link rel="stylesheet" media="screen" href="/stylesheets/app.css"></head><body><a id="totop" href="#page-header" class="iconfont">&#xe60b;</a><header id="page-header"><div class="wrapper"><a href="/page/profile.html"><img alt="avatar" src="/images/avatar.jpg" class="avatar"></a><div class="title"> <a href="/">天镶的博客</a></div><nav class="nav"><ul class="links"><li><a href="/"> 首页</a></li><li><a href="/archives"> 归档</a></li><li><a href="/page/profile.html"> 关于</a></li><li><a href="/page/gitbook/index.html"> 笔记</a></li></ul><div class="icons"><a href="/atom.xml" class="icon rss"><i class="iconfont">&#xe602;</i></a><a href="http://weibo.com/lingyucoder" class="icon weibo"><i class="iconfont">&#xe600;</i></a><a href="http://github.com/lingyucoder" class="icon github"><i class="iconfont">&#xe604;</i></a><a href="http://twitter.com/lingyucoder" class="icon twitter"><i class="iconfont">&#xe607;</i></a></div></nav></div></header><section id="wrapper"><div id="main"><article class="post"><div class="content desc typo"><h1 class="blog-title">如何写一个KISSY动画插件</h1><div class="toc-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSS与JavaScript动画对比"><span class="toc-number">1.</span> <span class="toc-text">CSS与JavaScript动画对比</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSS动画"><span class="toc-number">1.1.</span> <span class="toc-text">CSS动画</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#animation"><span class="toc-number">1.1.1.</span> <span class="toc-text">animation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transition"><span class="toc-number">1.1.2.</span> <span class="toc-text">transition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优缺点"><span class="toc-number">1.1.3.</span> <span class="toc-text">优缺点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript动画"><span class="toc-number">1.2.</span> <span class="toc-text">JavaScript动画</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#需求分析"><span class="toc-number">2.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#动画属性"><span class="toc-number">2.1.</span> <span class="toc-text">动画属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动画控制"><span class="toc-number">2.2.</span> <span class="toc-text">动画控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动画能够改变的内容"><span class="toc-number">2.3.</span> <span class="toc-text">动画能够改变的内容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动画对象"><span class="toc-number">3.</span> <span class="toc-text">动画对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动画队列"><span class="toc-number">4.</span> <span class="toc-text">动画队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#缓动函数"><span class="toc-number">5.</span> <span class="toc-text">缓动函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#样式处理"><span class="toc-number">6.</span> <span class="toc-text">样式处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#特殊处理"><span class="toc-number">7.</span> <span class="toc-text">特殊处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#颜色属性"><span class="toc-number">7.1.</span> <span class="toc-text">颜色属性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取"><span class="toc-number">7.1.1.</span> <span class="toc-text">获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析"><span class="toc-number">7.1.2.</span> <span class="toc-text">解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#计算"><span class="toc-number">7.1.3.</span> <span class="toc-text">计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#赋值"><span class="toc-number">7.1.4.</span> <span class="toc-text">赋值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#滚动"><span class="toc-number">7.2.</span> <span class="toc-text">滚动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取-1"><span class="toc-number">7.2.1.</span> <span class="toc-text">获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析-1"><span class="toc-number">7.2.2.</span> <span class="toc-text">解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#计算-1"><span class="toc-number">7.2.3.</span> <span class="toc-text">计算</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#赋值-1"><span class="toc-number">7.2.4.</span> <span class="toc-text">赋值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transform"><span class="toc-number">7.3.</span> <span class="toc-text">transform</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#获取-2"><span class="toc-number">7.3.1.</span> <span class="toc-text">获取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析-2"><span class="toc-number">7.3.2.</span> <span class="toc-text">解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#计算-2"><span class="toc-number">7.3.3.</span> <span class="toc-text">计算</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#赋值-2"><span class="toc-number">7.4.</span> <span class="toc-text">赋值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol></div><p>最近写东西写的比较少，并不代表我一直在划水。之前阿里的前辈布置了三个作业，其中一个就是基于KISSY写一个动画插件。事实上，KISSY已经有自己的动画模块，叫做<a href="http://docs.kissyui.com/1.4/docs/html/api/anim/index.html" target="_blank" rel="external">anim</a>，这里前辈的意思就是让我再造一个轮子，<a href="http://lingyucoder.github.io/kissy-anime-plugin/" target="_blank" rel="external">DEMO页面</a>，<a href="https://github.com/LingyuCoder/kissy-anime-plugin" target="_blank" rel="external">Github页面</a></p>
<a id="more"></a>

<p>目前已经有很多比较优秀的JavaScript动画实现了，比如<a href="https://github.com/sole/tween.js/" target="_blank" rel="external">Tween.js</a>，jQuery中的animate就是在Tween的基础上做了一层封装（2.0版本是Tween，老版本的jQuery则是自己实现的动画）。这里多多少少参照了优秀动画模块的思想和内容（比如缓动函数）。</p>
<h2 id="CSS与JavaScript动画对比">CSS与JavaScript动画对比</h2>
<p>首先需要确定为什么要开发JavaScript的动画模块，毕竟现在已经有CSS3动画了。这里先对比一下CSS动画和JavaScript动画的区别，并从中提炼出我们需要的信息</p>
<h3 id="CSS动画">CSS动画</h3>
<h4 id="animation">animation</h4>
<p>CSS3新增了一个<code>animation</code>属性，可以定义动画，相关的属性如下：</p>
<ol>
<li>animation-name：动画的名称，也就是定义的keyframes关键帧的名称</li>
<li>animation-duration：一次动画的时长</li>
<li>animation-timing-funciton：缓动函数，这个后面会有详细介绍</li>
<li>animation-delay：动画延迟时间</li>
<li>animation-iteration-count：动画的播放次数</li>
<li>animation-direction：动画时正向播放还是倒着播放</li>
<li>animation-play-state：动画的状态，暂停还是播放</li>
<li>animation-fill-mode：动画播放时间之外的状态，是否重回动画初始</li>
<li>animation：复合属性，上面属性合在一起的写法</li>
</ol>
<p>可以看到，这里定义了一个动画的整体属性，但并没有定义具体的样式改变。这个任务交给了<code>keyframes</code>去做。也即是说，<code>animation</code>不会单独存在，它总是通过<code>animation-name</code>关联到某个<code>keyframes</code>，这是一个多对一的关系。在<code>keyframes</code>中，具体定义了这个动画哪些样式需要改变，改变多少。</p>
<h4 id="transition">transition</h4>
<p>另外，还有一个<code>transition</code>属性，可以定义过渡效果，相关属性如下：</p>
<ol>
<li>transition-property：需要参与过渡的属性</li>
<li>transition-duration 过渡的时长</li>
<li>transition-timing-function：过渡的缓动函数</li>
<li>transition-delay：过渡的延时</li>
</ol>
<p><code>transtion</code>定义的是过渡效果，所谓过渡，就是当某个样式改变时，浏览器不会立即赋予这个改变后的值，而是从初始值逐渐改变，平滑的转变成改变后的值。这样也能形成很优秀的动画效果。同时不需要与<code>keyframes</code>结合，可以自己独立存在。</p>
<h4 id="优缺点">优缺点</h4>
<p>先来说说优点，CSS3的动画的效率要比JavaScript要高，这不是通过优化JavaScript代码就能逆转的。由于CSS3动画作为浏览器渲染引擎实现的一部分，相对于JavaScript动画而言，省去了JavaScript部分，直接由底层语言实现，并且其内部可由浏览器做一系列相关的优化。比如webkit，它可以专门为动画元素创建一个图层，然后将这个元素的样式转变在主线程之外运行。</p>
<p>但是，CSS3动画缺乏足够的控制能力，同时，如果我们动画改变的不是CSS属性（比如滚动，这也是视差滚动必须通过JavaScript实现的原因），CSS3的动画就没辙了。另外，其浏览器的兼容性也是很大问题。毕竟IE从9开始才逐渐开始实现CSS3，如果要在IE6~8中做动画效果，就得另寻他法了</p>
<p>另外，<a href="http://lingyu.wang/#/item" target="_blank" rel="external">这里</a>有我曾经写过的一些CSS3动画效果</p>
<h3 id="JavaScript动画">JavaScript动画</h3>
<p>JavaScript的动画，说白了就是每隔一小段时间修改元素的CSS样式。这个间隔时间一般是1000/60ms，也就是说，每秒钟该60次，达到一秒60帧的效果。每次修改，大致需要经过如下流程：</p>
<ol>
<li>计算当前元素样式</li>
<li>修改元素样式</li>
<li>重绘元素</li>
</ol>
<p>前两部都是通过JavaScript完成，这也意味着，它不精确。如我们所知，JavaScript的定时函数<code>setTimeout</code>和<code>setInterval</code>本来就不是很精确（现在可以使用requestAnimationFrame，但老版本IE不兼容），而JavaScript运行在主线程——UI线程上，上面运行的其他任务（样式计算、布局、绘制、其他JavaScript代码等）都可能造成线程的阻塞。这也是JavaScript动画的最大弊病。</p>
<p>但JavaScript本身，拥有强大的控制能力，它可以随心所欲的控制动画，开始、暂停、倒放、中止、回放、单帧等等，这些JavaScript都能搞定。而像CSS动画无法做的滚动效果，JavaScript也可以轻松实现。而且，我们可以将动画扩展到IE 6~8上（当然transform还是不兼容）。</p>
<h2 id="需求分析">需求分析</h2>
<h3 id="动画属性">动画属性</h3>
<p>通过参考CSS动画实现，我们也可以很容易的确定，通过实现JavaScript实现动画时，动画应该具备的属性：</p>
<ol>
<li>涉及的元素（elems）</li>
<li>需要改变的样式（styles）</li>
<li>时长（duration）</li>
<li>缓动函数（easing-function）</li>
<li>播放次数（times）</li>
</ol>
<h3 id="动画控制">动画控制</h3>
<p>而控制上，我们应该实现的功能：</p>
<ol>
<li>开始（run）</li>
<li>暂停（pause）</li>
<li>暂停恢复（resume）</li>
<li>中止（stop）</li>
<li>倒放（reverse）</li>
<li>单帧（go）</li>
</ol>
<h3 id="动画能够改变的内容">动画能够改变的内容</h3>
<p>需要能够改变的内容有：</p>
<ol>
<li>CSS样式</li>
<li>滚动</li>
</ol>
<h2 id="动画对象">动画对象</h2>
<p>如之前所说，JavaScript动画，实际上就是每隔一小段时间改变元素的样式。我们可以把动画看做一个对象，其内部有这个动画相关的元素、动画的属性，并提供一系列的接口控制这个动画</p>
<p>所以，动画的对象大致上是这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Anime</span><span class="params">()</span></span>{}</div><div class="line">Anime.prototype.run = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{};</div><div class="line">Anime.prototype.pause = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{};</div><div class="line">Anime.prototype.resume = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{};</div><div class="line">Anime.prototype.stop = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{};</div><div class="line">Anime.prototype.go = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>{};</div></pre></td></tr></table></figure>

<p>而倒放是事先定义好的，我们可以作为动画属性传入</p>
<p>动画最终要的，就是参与动画的元素，和需要被改变的样式及其目标值。这两者，我们是没办法通过给默认值的形式来省略的。其他的，我们可以通过给一些默认值来简化API，所以将接口设计成如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Anime</span><span class="params">(elems, styles, config)</span></span>{}</div></pre></td></tr></table></figure>

<p>conifg是一个对象，剩下的可选属性都在其中定义，通过mixin的方式加入到动画对象中，还可以提供一些默认值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defaultConfig = {</div><div class="line">    callback: noop,</div><div class="line">    duration: <span class="number">1500</span>,</div><div class="line">    reverse: <span class="literal">false</span>,</div><div class="line">    easing: <span class="string">"linear"</span>,</div><div class="line">    times: <span class="number">1</span>,</div><div class="line">    spend: <span class="number">0</span>,</div><div class="line">    state: <span class="string">"running"</span></div><div class="line">};</div></pre></td></tr></table></figure>

<p>这里还加了一些其他属性，比如spend和state，spend实际上就是当前动画运行了多长时间，state则是动画对象当前的状态，是播放中（running），还是暂停（paused），还是结束（ended）。state结合控制来做的话，就是一个状态机：</p>
<ul>
<li>running为初始状态，可以通过pause方法，转到paused状态，也可以通过stop方法，转到ended状态</li>
<li>paused为暂停状态，通过resume方法，转到running状态，也可以通过stop转到ended状态</li>
<li>ended为终止状态，可以通过run放法进行重放，转到running状态</li>
</ul>
<h2 id="动画队列">动画队列</h2>
<p>光有动画对象是不够的，我们需要对所有的动画对象进行处理，获取其中running状态的对象，每隔一小段时间，修改其状态，并绘制到页面上。这里就需要一个动画队列了，实际上也就是一个数组，里面的每个元素都是状态为running的动画对象。每隔1000/60ms就遍历一遍这个数组，更新每一个动画对象的状态，并进行绘制。</p>
<p>需要注意的地方是，队列中只有running状态的对象，也就是说，如果队列中没有元素，那么就不需要每隔一段时间去遍历了。另外，如果有动画运行结束，变成不是running状态，那么需要从动画队列中移除</p>
<p>所以，队列首先得实现相关的添加删除操作，注意去重：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> animeQueue = [];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addAnime</span><span class="params">(anime)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (S.indexOf(anime, animeQueue) === -<span class="number">1</span>) {</div><div class="line">        animeQueue.push(anime);</div><div class="line">        checkRunning();</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteAnime</span><span class="params">(anime)</span> </span>{</div><div class="line">    <span class="keyword">var</span> index = S.indexOf(anime, animeQueue);</div><div class="line">    <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) {</div><div class="line">        animeQueue.splice(index, <span class="number">1</span>);</div><div class="line">        checkRunning();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>然后，还有一个心跳函数，用于每隔一段时间遍历动画队列：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">pulse</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">var</span> deleteIndex = [],</div><div class="line">        i, m, tmp;</div><div class="line">    <span class="keyword">if</span> (running) {</div><div class="line">        S.each(animeQueue, <span class="function"><span class="keyword">function</span><span class="params">(anime, index)</span> </span>{</div><div class="line">            <span class="keyword">if</span> (anime.state === <span class="string">"running"</span>) {</div><div class="line">                anime.go();</div><div class="line">            } <span class="keyword">else</span> {</div><div class="line">                deleteIndex.push(index);</div><div class="line">            }</div><div class="line">        });</div><div class="line">        <span class="keyword">for</span> (i = deleteIndex.length; i--;) {</div><div class="line">            animeQueue.splice(deleteIndex[i], <span class="number">1</span>);</div><div class="line">        }</div><div class="line">        dealing = <span class="literal">false</span>;</div><div class="line">        checkRunning();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>checkRunning函数，来决定下一帧，是否需要运行，如果队列中没有动画对象了，自然不需要运行了，否则就要继续遍历动画队列：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkRunning</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (animeQueue.length &gt; <span class="number">0</span>) {</div><div class="line">        running = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">if</span> (!dealing) {</div><div class="line">            dealing = <span class="literal">true</span>;</div><div class="line">            requestAnimationFrame(pulse);</div><div class="line">        }</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        running = <span class="literal">false</span>;</div><div class="line">        dealing = <span class="literal">false</span>;</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="缓动函数">缓动函数</h2>
<p>缓动函数的说明和教程网上还是比较多的，说白了就是一个进度的映射。一般都是使用一些现有的缓动函数，我直接从Tween中把它的缓动函数扒了出来…</p>
<h2 id="样式处理">样式处理</h2>
<p>动画可以理解为三个问题，从什么地方开始，经过什么样的过程，到什么地方去。我们可以通过构建动画对象时传入的styles来确定需要修改的样式，以及样式动画最终的目标值。这个目标值可以是绝对的，比如<code>width: 400px</code>，就是要修改宽度到400像素，但也可以相对的，比如<code>width: +=200px</code>，在原有基础上增大200像素的宽度。我们需要确定元素样式的起始值、绝对的目标值，才能算出某个时间点的中间值，并将中间值赋予给元素。所以，样式的处理应该包括四个部分：</p>
<ol>
<li>从元素获取样式的起始值（从什么地方开始）</li>
<li>获取样式的绝对目标值，如果传入的是相对值，那么需要通过起始值来计算的处绝对目标值（到什么地方去）</li>
<li>计算当前时间点的中间值（经过怎样的过程）</li>
<li>向元素赋予计算出来的中间值（经过怎样的过程）</li>
</ol>
<p>后两个一个是计算，一个是展示，都属于过程内容。可以把这四个部分抽象成四个方法，分别是获取、解析、计算、赋值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCSS</span><span class="params">(elem, style)</span> </span>{</div><div class="line">    <span class="keyword">var</span> val;</div><div class="line">    <span class="keyword">if</span> (hooks[style] && hooks[style].get) {</div><div class="line">        val = hooks[style].get(elem, style);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        val = hooks._default.get(elem, style);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> parseCSS(val, style);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseCSS</span><span class="params">(val, style, from)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (hooks[style] && hooks[style].parse) {</div><div class="line">        <span class="keyword">return</span> hooks[style].parse(val, from);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> hooks._default.parse(val, from);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeCSS</span><span class="params">(style, from, to, pos)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (hooks[style] && hooks[style].compute) {</div><div class="line">        <span class="keyword">return</span> hooks[style].compute(from, to, pos);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> hooks._default.compute(from, to, pos);</div><div class="line"></div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">assignCSS</span><span class="params">(elem, style, val)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (hooks[style] && hooks[style].assign) {</div><div class="line">        <span class="keyword">return</span> hooks[style].assign(elem, style, val);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> hooks._default.assign(elem, style, val);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这里，可以看到很多hooks，阅读过jQuery源码的不会对这种方式陌生。钩子是为特别样式提供特别处理，如果不需要通过钩子进行处理，直接使用_default提供的默认处理方式就行了</p>
<h2 id="特殊处理">特殊处理</h2>
<p>一般的属性，可以通过<code>Dom.css</code>很轻松的获取起始值并计算出绝对目标值，但有一些则不然，这里列三个特例</p>
<h3 id="颜色属性">颜色属性</h3>
<p>如color、background等，这些我们应该为其提供渐变，但无论是用户传入的目标值，还是获取到的值，都有好几个形式：</p>
<ol>
<li>HEX：<code>#fff</code>或<code>#f0f0f0</code></li>
<li>RGB：<code>rgb(245, 28, 33)</code></li>
<li>RGBA：<code>rgba(245, 28, 33, .6)</code></li>
<li>直接名称：<code>red</code>、<code>white</code>等等</li>
<li>HSL和HSLA，这里不做实现</li>
</ol>
<h4 id="获取">获取</h4>
<p>获取和一般CSS属性没差， 直接使用默认方式了</p>
<h4 id="解析">解析</h4>
<p>一般，是统一将其解析成RGBA的形式来做，如果不支持RGBA的浏览器，解析成RGB。这样我们就拥有了两个三个元素（RGB）或四个元素的数组（RGBA），一个数组为起始值，一个数组为目标值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseColor</span><span class="params">(val)</span> </span>{</div><div class="line">    val = val.replace(rClearSpace, <span class="string">""</span>).toLowerCase();</div><div class="line">    <span class="keyword">if</span> (normalColors[val]) {</div><div class="line">        <span class="keyword">return</span> normalColors[val];</div><div class="line">    }</div><div class="line">    <span class="keyword">var</span> color = [];</div><div class="line">    <span class="keyword">var</span> tmp;</div><div class="line">    <span class="keyword">var</span> i;</div><div class="line">    <span class="keyword">if</span> (rHexColor.test(val)) {</div><div class="line">        tmp = [];</div><div class="line">        <span class="keyword">if</span> (val.length === <span class="number">4</span>) {</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">3</span>; i--;) {</div><div class="line">                tmp[i] = val.charAt(i + <span class="number">1</span>);</div><div class="line">                tmp[i] += tmp[i];</div><div class="line">            }</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (val.length === <span class="number">7</span>) {</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">3</span>; i--;) {</div><div class="line">                tmp[i] = val.substr(<span class="number">1</span> + i * <span class="number">2</span>, <span class="number">2</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">3</span>; i--;) {</div><div class="line">            color[i] = <span class="built_in">parseInt</span>(tmp[i], <span class="number">16</span>);</div><div class="line">        }</div><div class="line">        color[<span class="number">3</span>] = <span class="number">1</span>;</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!S.isNull(tmp = val.match(rRGB))) {</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">3</span>; i--;) {</div><div class="line">            color[i] = <span class="built_in">parseInt</span>(tmp[i + <span class="number">1</span>], <span class="number">10</span>);</div><div class="line">        }</div><div class="line">        color[<span class="number">3</span>] = <span class="number">1</span>;</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!S.isNull(tmp = val.match(rRGBA))) {</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">4</span>; i--;) {</div><div class="line">            color[i] = <span class="built_in">Number</span>(tmp[i + <span class="number">1</span>]);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> color;</div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="计算">计算</h4>
<p>计算中间值的过程则是对颜色数组中的每一个元素（R或G或B或A）计算一下中间值就行了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeColor</span><span class="params">(from, to, pos)</span> </span>{</div><div class="line">    <span class="keyword">var</span> _default = hooks._default,</div><div class="line">        result = [],</div><div class="line">        i;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; i++) {</div><div class="line">        result.push(<span class="built_in">parseInt</span>(_default.compute(from[i], to[i], pos), <span class="number">10</span>));</div><div class="line">    }</div><div class="line">    result.push(_default.compute(from[<span class="number">3</span>], to[<span class="number">3</span>], pos));</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">}</div></pre></td></tr></table></figure>

<h4 id="赋值">赋值</h4>
<p>赋值的时候，我们需要将数组恢复成CSS中的方式，也就是恢复成RGB或RGBA的方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">assignColor</span><span class="params">(elem, style, val)</span> </span>{</div><div class="line">    <span class="keyword">if</span>(KISSY.Features.isIELessThan(<span class="number">9</span>)){</div><div class="line">        Dom.css(elem, style, <span class="string">"rgb("</span> + val.slice(<span class="number">0</span>, <span class="number">3</span>).join(<span class="string">","</span>) + <span class="string">")"</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        Dom.css(elem, style, <span class="string">"rgba("</span> + val.join(<span class="string">","</span>) + <span class="string">")"</span>);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="滚动">滚动</h3>
<h4 id="获取-1">获取</h4>
<p>滚动并不属于CSS属性，但我们经常会使用，比如滚动到页首。KISSY本身提供了包装，可以获取当前滚动的高度</p>
<h4 id="解析-1">解析</h4>
<p>通过KISSY获取的滚动属性值无需解析，可以使用默认解析</p>
<h4 id="计算-1">计算</h4>
<p>计算过程也是，使用默认计算即可</p>
<h4 id="赋值-1">赋值</h4>
<p>赋值过程就和一般的CSS属性不一样了，使用KISSY提供的接口进行赋值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">S.each(<span class="string">"scrollTop scrollLeft"</span>.split(<span class="string">" "</span>), <span class="function"><span class="keyword">function</span><span class="params">(type)</span> </span>{</div><div class="line">    <span class="keyword">var</span> _default = hooks._default;</div><div class="line">    hooks[type] = {</div><div class="line">        assign: <span class="function"><span class="keyword">function</span><span class="params">(elem, style, val)</span> </span>{</div><div class="line">            Dom[type](elem, val);</div><div class="line">        },</div><div class="line">        get: <span class="function"><span class="keyword">function</span><span class="params">(elem, style)</span> </span>{</div><div class="line">            <span class="keyword">return</span> Dom[type](elem);</div><div class="line">        }</div><div class="line">    };</div><div class="line">});</div></pre></td></tr></table></figure>

<h3 id="transform">transform</h3>
<p><strong>这里只处理了2D的transform</strong></p>
<p>transform的值也有很多不同的形式：</p>
<ol>
<li>matrix</li>
<li>rotate</li>
<li>translate、translateX、translateY</li>
<li>scale、scaleX、scaleY</li>
<li>skew、skewX、skewY</li>
</ol>
<h4 id="获取-2">获取</h4>
<p>获取的过程和一般CSS元素获取的过程没有差别，使用默认的方式就好</p>
<h4 id="解析-2">解析</h4>
<p>这里就比较麻烦了，需要处理所有的情况，我们将所有的情况转变成如下的结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> result = {</div><div class="line">    translateX: <span class="number">0</span>,</div><div class="line">    translateY: <span class="number">0</span>,</div><div class="line">    rotate: <span class="number">0</span>,</div><div class="line">    skewX: <span class="number">0</span>,</div><div class="line">    skewY: <span class="number">0</span>,</div><div class="line">    scaleX: <span class="number">1</span>,</div><div class="line">    scaleY: <span class="number">1</span></div><div class="line">};</div></pre></td></tr></table></figure>

<p>代码较长</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">decomposeMatrix</span><span class="params">(matrix)</span> </span>{</div><div class="line">    <span class="keyword">var</span> scaleX, scaleY, skew,</div><div class="line">        A = matrix[<span class="number">0</span>],</div><div class="line">        B = matrix[<span class="number">1</span>],</div><div class="line">        C = matrix[<span class="number">2</span>],</div><div class="line">        D = matrix[<span class="number">3</span>];</div><div class="line"></div><div class="line">    <span class="comment">// Make sure matrix is not singular</span></div><div class="line">    <span class="keyword">if</span> (A * D - B * C) {</div><div class="line">        scaleX = <span class="built_in">Math</span>.sqrt(A * A + B * B);</div><div class="line">        skew = (A * C + B * D) / (A * D - C * B);</div><div class="line">        scaleY = (A * D - B * C) / scaleX;</div><div class="line">        <span class="comment">// step (6)</span></div><div class="line">        <span class="keyword">if</span> (A * D &lt; B * C) {</div><div class="line">            skew = -skew;</div><div class="line">            scaleX = -scaleX;</div><div class="line">        }</div><div class="line">        <span class="comment">// matrix is singular and cannot be interpolated</span></div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="comment">// In this case the elem shouldn't be rendered, hence scale == 0</span></div><div class="line">        scaleX = scaleY = skew = <span class="number">0</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// The recomposition order is very important</span></div><div class="line">    <span class="comment">// see http://hg.mozilla.org/mozilla-central/file/7cb3e9795d04/layout/style/nsStyleAnimation.cpp#l971</span></div><div class="line">    <span class="keyword">return</span> {</div><div class="line">        translateX: myParse(matrix[<span class="number">4</span>]),</div><div class="line">        translateY: myParse(matrix[<span class="number">5</span>]),</div><div class="line">        rotate: myParse(<span class="built_in">Math</span>.atan2(B, A) * <span class="number">180</span> / <span class="built_in">Math</span>.PI),</div><div class="line">        skewX: myParse(<span class="built_in">Math</span>.atan(skew) * <span class="number">180</span> / <span class="built_in">Math</span>.PI),</div><div class="line">        skewY: <span class="number">0</span>,</div><div class="line">        scaleX: myParse(scaleX),</div><div class="line">        scaleY: myParse(scaleY)</div><div class="line">    };</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">valueStringToArray</span><span class="params">(val)</span> </span>{</div><div class="line">    <span class="keyword">var</span> result = val.split(<span class="string">","</span>);</div><div class="line">    result = S.map(result, <span class="function"><span class="keyword">function</span><span class="params">(value)</span> </span>{</div><div class="line">        <span class="keyword">return</span> myParse(value);</div><div class="line">    });</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseTransform</span><span class="params">(val)</span> </span>{</div><div class="line">    <span class="keyword">var</span> result = {</div><div class="line">        translateX: <span class="number">0</span>,</div><div class="line">        translateY: <span class="number">0</span>,</div><div class="line">        rotate: <span class="number">0</span>,</div><div class="line">        skewX: <span class="number">0</span>,</div><div class="line">        skewY: <span class="number">0</span>,</div><div class="line">        scaleX: <span class="number">1</span>,</div><div class="line">        scaleY: <span class="number">1</span></div><div class="line">    };</div><div class="line">    <span class="keyword">var</span> value;</div><div class="line">    <span class="keyword">var</span> regResult;</div><div class="line">    <span class="keyword">var</span> i, j, m;</div><div class="line">    <span class="keyword">var</span> name;</div><div class="line">    <span class="keyword">var</span> strs;</div><div class="line">    strs = val.replace(rClearSpace, <span class="string">""</span>).split(<span class="string">")"</span>);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>, m = strs.length; i &lt; m; i++) {</div><div class="line">        <span class="keyword">if</span> (!strs[i] || strs[i] === <span class="string">"none"</span>) <span class="keyword">continue</span>;</div><div class="line">        regResult = strs[i].split(<span class="string">"("</span>);</div><div class="line">        name = regResult[<span class="number">0</span>];</div><div class="line">        value = valueStringToArray(regResult[<span class="number">1</span>]);</div><div class="line">        <span class="keyword">switch</span> (name) {</div><div class="line">            <span class="keyword">case</span> <span class="string">"matrix"</span>:</div><div class="line">                result = decomposeMatrix(value);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">"translate"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"skew"</span>:</div><div class="line">                result[name + <span class="string">"X"</span>] = value[<span class="number">0</span>] || <span class="number">0</span>;</div><div class="line">                result[name + <span class="string">"Y"</span>] = value[<span class="number">1</span>] || <span class="number">0</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">"scale"</span>:</div><div class="line">                result[name + <span class="string">"X"</span>] = value[<span class="number">0</span>] || <span class="number">0</span>;</div><div class="line">                result[name + <span class="string">"Y"</span>] = value[<span class="number">1</span>] || result[name + <span class="string">"X"</span>];</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">"translateX"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"translateY"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"scaleX"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"scaleY"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"skewX"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"skewY"</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">"rotate"</span>:</div><div class="line">                result[name] = value[<span class="number">0</span>] || <span class="number">0</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>这其中decomposeMatrix函数来自KISSY，将matrix转换成变换属性的形式。</p>
<h4 id="计算-2">计算</h4>
<p>获取到上面的结构后，只需要对其中的每一项计算中间值就可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeTransform</span><span class="params">(from, to, pos)</span> </span>{</div><div class="line">    <span class="keyword">var</span> _default = hooks._default;</div><div class="line">    <span class="keyword">var</span> result = {};</div><div class="line">    S.each(to, <span class="function"><span class="keyword">function</span><span class="params">(value, key)</span> </span>{</div><div class="line">        result[key] = _default.compute(from[key], to[key], pos);</div><div class="line">    });</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="赋值-2">赋值</h3>
<p>赋值也是一样，将上面的结构一一提取合并，组成一个字符串，另外需要注意添加上相应的单位：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">assignTransform</span><span class="params">(elem, style, val)</span> </span>{</div><div class="line">    <span class="keyword">var</span> valueArray = [];</div><div class="line">    S.each(val, <span class="function"><span class="keyword">function</span><span class="params">(value, key)</span> </span>{</div><div class="line">        <span class="keyword">if</span> ((key.indexOf(<span class="string">"scale"</span>) &gt; -<span class="number">1</span> && value === <span class="number">1</span>) || (key.indexOf(<span class="string">"scale"</span>) === -<span class="number">1</span> && value === <span class="number">0</span>)) {</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">if</span> (key === <span class="string">"rotate"</span> || key.indexOf(<span class="string">"skew"</span>) &gt; -<span class="number">1</span>) {</div><div class="line">            value += <span class="string">"deg"</span>;</div><div class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (key.indexOf(<span class="string">"translate"</span>) &gt; -<span class="number">1</span>) {</div><div class="line">            value += <span class="string">"px"</span>;</div><div class="line">        }</div><div class="line">        valueArray.push(key + <span class="string">"("</span> + value + <span class="string">")"</span>);</div><div class="line">    });</div><div class="line">    Dom.css(elem, style, valueArray.join(<span class="string">" "</span>));</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="总结">总结</h2>
<p>这是一次造轮子实验，效果还是出来了，基本的动画都能完成，且兼容IE 6，transform部分兼容到IE 9，虽然不可能直接替代KISSY的anim模块，但用起来也不算差，毕竟兼容问题都让KISSY去做了。毕竟这只是个作业，中间搞搞停停弄了3天，之后就是写DEMO之类的。后面打算优化一下代码</p>
<hr><div class="tags"><a href="/tags/HTML/" class="blog-tag">HTML</a><a href="/tags/CSS/" class="blog-tag">CSS</a><a href="/tags/JavaScript/" class="blog-tag">JavaScript</a><a href="/tags/Kissy/" class="blog-tag">Kissy</a><a href="/tags/动画/" class="blog-tag">动画</a></div><hr><div class="jia"><div class="jiathis_style_32x32"><a class="jiathis_button_qzone"></a><a class="jiathis_button_tsina"></a><a class="jiathis_button_tqq"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_renren"></a><a href="http://www.jiathis.com/share?uid=1409314953297200" target="_blank" class="jiathis jiathis_txt jtico jtico_jiathis"></a></div><script type="text/javascript">var jiathis_config = {data_track_clickback:'true'};    </script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1409314953297200" charset="utf-8"></script></div><hr><div id="duoshuo" data-url="http://lingyu.wang/2014/05/31/kissy-anime-plugin/" data-thread-key="/blog/2014/05/31/kissy-anime-plugin/" data-title="如何写一个KISSY动画插件" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name:'skyinlayer'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div></article><div class="pager"><a href="/2014/07/29/generator/" title="细说Generator" class="pre">上一页</a><a href="/2014/05/22/webrtc-data-channels/" title="WebRTC的RTCDataChannel" class="next">下一页</a></div></div><aside id="aside"><section class="recent"><h3 class="title iconfont">最新文章<i>&#xe601;</i></h3><div class="links"><ul><li><a href="/2014/09/24/koa-anywhere/">koa-anywhere</a></li><li><a href="/2014/09/22/learn-fe/">学前端的一点总结</a></li><li><a href="/2014/07/29/generator/">细说Generator</a></li><li><a href="/2014/05/31/kissy-anime-plugin/">如何写一个KISSY动画插件</a></li><li><a href="/2014/05/22/webrtc-data-channels/">WebRTC的RTCDataChannel</a></li></ul></div></section><section class="categories"><h3 class="title iconfont">分类<i>&#xe605;</i></h3><div class="links"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术/">前端技术</a><span class="category-list-count">33</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术/性能优化/">性能优化</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术/笔试面试积累/">笔试面试积累</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术/网站建设/">网站建设</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/即时通信/">即时通信</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/性能优化/">性能优化</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库技术/">数据库技术</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码阅读/">源码阅读</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活情感/">生活情感</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔试面试积累/">笔试面试积累</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网站建设/">网站建设</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">9</span></li></ul></div></section><section class="tags"><h3 class="title iconfont">标签<i>&#xe603;</i></h3><div class="links"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a><span class="tag-list-count">35</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Generator/">Generator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">34</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kissy/">Kissy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeJs/">NodeJs</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEO/">SEO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebIM/">WebIM</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebRTC/">WebRTC</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/">WebSocket</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grunt/">grunt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jQuery/">jQuery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/koa/">koa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/">oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xmpp/">xmpp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/响应式/">响应式</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/存储函数/">存储函数</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/思考/">思考</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生活/">生活</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔试面试题/">笔试面试题</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计/">设计</a><span class="tag-list-count">9</span></li></ul></div></section><section class="archives"><h3 class="title iconfont"> 归档<i>&#xe60a;</i></h3><div class="links"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09">2014年9月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07">2014年7月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05">2014年5月</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04">2014年4月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03">2014年3月</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02">2014年2月</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01">2014年1月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12">2013年12月</a><span class="archive-list-count">1</span></li></ul></div></section></aside></section><footer id="page-footer"><span style="float:right"><script type="text/javascript">(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-51090540-1', 'http://plugins.lingyu.wang');
ga('send', 'pageview');</script></span><span style="float:right"><script type="text/javascript">var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5aa4945a04cc5a5a4cd6835ccb7d419' type='text/javascript'%3E%3C/script%3E"));</script></span><p>&copy;Powered by<a href="http://hexo.io" target="_blank" title="hexo">&nbsp;hexo&nbsp;</a>and Theme by<a href="https://github.com/LingyuCoder/lingyu-theme">&nbsp;LingyuCoder</a></p></footer><script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script><script type="text/javascript">$(function(){
    var duoshuoIds = [];
    var map = {};
    $('.meta').each(function(){
        var $this = $(this);
        var id = $this.attr('thread');
        duoshuoIds.push(id);
        map[id] = $this;
    });
    duoshuoIds.length && $.ajax({
        url: 'http://api.duoshuo.com/threads/counts.jsonp',
        data: {
            threads: duoshuoIds.join(','),
            short_name: 'skyinlayer'
        },
        success: function(data){
            $.each(data.response, function(key, value){
                var $el = map[key];
                if($el) {
                    $.each(['comments','likes', 'reposts'], function(index, type){
                        $el.find('.' + type).append('<span>' + value[type] + '</span>');
                    });
                }
            });
        },
        dataType: 'jsonp'
    });
});</script></body></html>