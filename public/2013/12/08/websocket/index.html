<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="author" content="天镶"><meta name="description"><title>搭建HTML5简易聊天室 | 天镶的博客</title><link href="/favicon.ico" rel="icon"><link rel="stylesheet" media="screen" href="/stylesheets/plugins/typo/typo-1.1.css"><link rel="stylesheet" media="screen" href="/stylesheets/plugins/highlight/highlight-8.0-dark.css"><link rel="stylesheet" media="screen" href="/stylesheets/app.css"></head><body><a id="totop" href="#page-header" class="iconfont">&#xe60b;</a><header id="page-header"><div class="wrapper"><a href="/page/profile.html"><img alt="avatar" src="/images/avatar.jpg" class="avatar"></a><div class="title"> <a href="/">天镶的博客</a></div><nav class="nav"><ul class="links"><li><a href="/"> 首页</a></li><li><a href="/archives"> 归档</a></li><li><a href="/page/profile.html"> 关于</a></li><li><a href="http://read.lingyu.wang/"> 笔记</a></li><li><a href="http://lingyucoder.github.io/diary"> 日记</a></li></ul><div class="icons"><a href="/atom.xml" class="icon rss"><i class="iconfont">&#xe602;</i></a><a href="http://weibo.com/lingyucoder" class="icon weibo"><i class="iconfont">&#xe600;</i></a><a href="http://github.com/lingyucoder" class="icon github"><i class="iconfont">&#xe604;</i></a><a href="http://twitter.com/lingyucoder" class="icon twitter"><i class="iconfont">&#xe607;</i></a></div></nav></div></header><section id="wrapper"><div id="main"><article class="post"><div class="content desc typo"><h1 class="blog-title">搭建HTML5简易聊天室</h1><div class="toc-index"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前面的话"><span class="toc-number">1.</span> <span class="toc-text">前面的话</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket"><span class="toc-number">2.</span> <span class="toc-text">WebSocket</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket服务器实现"><span class="toc-number">3.</span> <span class="toc-text">WebSocket服务器实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebSocket客户端实现"><span class="toc-number">4.</span> <span class="toc-text">WebSocket客户端实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#写在最后"><span class="toc-number">5.</span> <span class="toc-text">写在最后</span></a></li></ol></div><h3 id="前面的话">前面的话</h3>
<hr>
<p>之前曾经写过一个符合xmpp协议的Web IM，但使用的是JSJaC，后台用的也是与之配套的jabber client，发现nodejs的事件模式更适合作为Web IM的客户端。</p>
<p>而传统的ajax轮询机制也早晚被全双工websocket所取代，所以就打算在我的毕业设计的Web IM平台中使用websocket。</p>
<p>在这里调研一下并作出了一个简单的版聊demo，这里讲一下这个简单demo的实现方式</p>
<a id="more"></a>

<h3 id="WebSocket">WebSocket</h3>
<hr>
<p>什么是WebSocket？</p>
<p><a href="http://datatracker.ietf.org/doc/rfc6455/?include_text=1" target="_blank">WebSocket的协议</a> 目前还没有仔细去研读，有时间研读一下</p>
<p>根据<a href="http://www.websocket.org/" target="_blank">WebSocket.org</a>上的定义：</p>
<blockquote>
<p>The WebSocket specification—developed as part of the HTML5 initiative—      introduced the WebSocket JavaScript interface, which defines a full-duplex single socket connection over which messages can be sent between client and server. The WebSocket standard simplifies much of the complexity around bi-directional web communication and connection management.</p>
</blockquote>
<p>如上所述websocket定义了一个浏览器和服务器之间的全双工的单一的socket连接。</p>
<p>WebSocket的API？</p>
<p><a href="http://dev.w3.org/html5/websockets/" target="_blank">W3C的WS的API</a> ，定义了具体的WS的接口，而一般只要注意怎么使用就行了，可以清楚地看到WS客户端的几个事件：</p>
<ol>
<li>onopen  在WS客户端和WS服务器建立连接成功后调用</li>
<li>onmessage 在WS服务器给WS客户端发送数据时调用</li>
<li>onerror 如果连接失败，发送、接收数据失败或者处理数据出现错误，则会被调用</li>
<li>onclose 在WS客户端接收到WS服务器关闭时进行调用</li>
</ol>
<h3 id="WebSocket服务器实现">WebSocket服务器实现</h3>
<hr>
<p>nodejs有很多websocket的三方库，都很实用，在stackoverflow上有人问过具体应该使用哪个库，而回答者给与了<a href="http://stackoverflow.com/questions/16392260/which-websocket-library-to-use-with-node-js" target="_blank">较为全面的解答</a></p>
<p>这里面对各个websocket库进行了一个对比，可以根据自己的需要选择。</p>
<p>其中可以注意一下<a href="http://socket.io/#home" target="_blank">socket.io</a>，它对不同的浏览器有比较好的支持，在不支持websocket的时候可以转变成ajax的轮询等其他的替换，浏览器的支持也相当不错。同时还能和目前比较流行的node的web框架express相结合，其文档的例子写的很好。</p>
<p>由于我只是想搭建一个简单快捷的WS服务器，所以选用了号称probably the fastest WebSocket library for node.js的<a href="https://github.com/einaros/ws" target="_blank">ws</a> </p>
<p>在项目中使用npm安装：</p>
<pre><code> npm <span class="keyword">install</span> ws
</code></pre><p>如果需要使用命令行的简易WS客户端，可以：</p>
<pre><code>npm <span class="keyword">install</span> ws -g
</code></pre><p>创建一个WS服务器：</p>
<pre><code><span class="keyword">var</span> WebSocketServer = <span class="built_in">require</span>(<span class="string">'ws'</span>).Server,
    wss = <span class="keyword">new</span> WebSocketServer({
    port: process.env.WSPORT || <span class="number">3001</span>
});
</code></pre><p>这样wss就成为了一个监听3001端口的WS服务器，我们需要为WS服务器创建WS客户端连接时候的事件：</p>
<pre><code>wss.<span class="keyword">on</span>(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(ws)</span> <span class="comment">{}</span>);</span>
</code></pre><p>这样，在有WS客户端连接我们的WS服务器时就会触发这个事件，但连接之后我么还需要传递信息，所以需要丰富这个事件的回调函数。</p>
<p>回调函数有一个参数ws，这个ws掌管着和WS客户端的连接，其事件也和WS客户端相同，不过不需要onopen。需要绑定的还有message，close：</p>
<pre><code>wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(ws)</span> {</span>
    ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>

    });
    ws.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>

    });
});
</code></pre><p>message事件在WS客户端给这个WS服务器发数据时调用，data就是这个数据，一般为string类型</p>
<p>close事件在WS客服端给这个WS服务器发送关闭请求时调用</p>
<p>一个简单的聊天室，需要在一个用户加入时告诉其他所有用户有新用户加入，也就是需要一个广播的方法，我们可以根据ws的示例来定义广播方法：</p>
<pre><code>wss.broadcast = <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.clients) <span class="keyword">this</span>.clients[i].send(<span class="built_in">JSON</span>.stringify(data));
};
</code></pre><p>这里可以看到wss的clients存放了所有与wss相连的WS客户端连接。</p>
<p>在一个WS客户端连接了WS服务器，我们需要把现有的所有房间内用户的信息给新进入房间的用户，并告诉所有房间内的用户有新用户加入，默认新进入房间的用户叫“游客”，修改代码：</p>
<pre><code>wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(ws)</span> {</span>
    ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
    });
    ws.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    });
    <span class="comment">//给每个用户一个单独的id</span>
    ws.uid = uuid.v4();
    <span class="comment">//新进入房间的用户的昵称</span>
    ws.nick = <span class="string">"游客"</span>;
    <span class="comment">//把目前所有房间内人员的信息发给新用户</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.clients) {
        ws.send(<span class="built_in">JSON</span>.stringify({
            nick: <span class="keyword">this</span>.clients[i].nick,
            uid: <span class="keyword">this</span>.clients[i].uid,
            type: <span class="string">"join"</span>
        }));
    }
    <span class="comment">//将新加入用户的信息告诉所有房间内的用户</span>
    wss.broadcast({
        nick: ws.nick,
        uid: ws.uid,
        type: <span class="string">"join"</span>
    });
});
</code></pre><p>这样新用户加入时的服务器端处理就完成了</p>
<p>在一个用户向服务器发送信息时,需要广播这条信息,同时也要指出发送人的信息,所以修改代码:</p>
<pre><code>ws<span class="built_in">.</span><span class="keyword">on</span>(<span class="string">'message'</span>, function(<span class="built_in">data</span>) {
    wss<span class="built_in">.</span>broadcast({
        nick: ws<span class="built_in">.</span>nick,
        uid: ws<span class="built_in">.</span>uid,
        time: moment(<span class="built_in">data</span><span class="built_in">.</span>time)<span class="built_in">.</span>format(<span class="string">"HH:mm:ss"</span>),
        message: <span class="built_in">data</span><span class="built_in">.</span>message,
        <span class="keyword">type</span>: <span class="string">"message"</span>
    });
});
</code></pre><p>在一个WS客户端向WS服务器发送关闭请求时，需要通知其他所有房间内的用户，所以修改代码：</p>
<pre><code>ws.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span> {
    wss.broadcast({
        nick: ws.nick,
        uid: ws.uid,
        <span class="built_in">type</span>: <span class="string">"exit"</span>
    });
});
</code></pre><p>在一个用户要修改自己的昵称，WS客户端需要向WS服务器发送申请，所以修改代码：</p>
<pre><code>ws<span class="built_in">.</span><span class="keyword">on</span>(<span class="string">'message'</span>, function(<span class="built_in">data</span>) {
    <span class="comment">//解析数据</span>
    <span class="built_in">data</span> <span class="subst">=</span> JSON<span class="built_in">.</span>parse(<span class="built_in">data</span>);
    <span class="comment">//若为message,则为WS客户端向WS服务器发送信息,进行广播</span>
    <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"message"</span>) {
        wss<span class="built_in">.</span>broadcast({
            nick: ws<span class="built_in">.</span>nick,
            uid: ws<span class="built_in">.</span>uid,
            time: moment(<span class="built_in">data</span><span class="built_in">.</span>time)<span class="built_in">.</span>format(<span class="string">"HH:mm:ss"</span>),
            message: <span class="built_in">data</span><span class="built_in">.</span>message,
            <span class="keyword">type</span>: <span class="string">"message"</span>
        });
    <span class="comment">//若为nickname,则为WS客户端向WS服务器发送昵称修改请求,则修改用户昵称,并进行广播</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"nickname"</span>) {
        wss<span class="built_in">.</span>broadcast({
            oldnick: ws<span class="built_in">.</span>nick,
            nick: <span class="built_in">data</span><span class="built_in">.</span>nick,
            uid: ws<span class="built_in">.</span>uid,
            <span class="keyword">type</span>: <span class="string">"nickname"</span>
        });
        ws<span class="built_in">.</span>nick <span class="subst">=</span> <span class="built_in">data</span><span class="built_in">.</span>nick;
    }
});
</code></pre><p>这样一个简单的聊天室的WS服务器就完成了,所有代码如下:</p>
<pre><code><span class="keyword">var</span> WebSocketServer = <span class="built_in">require</span>(<span class="string">'ws'</span>).Server,
    wss = <span class="keyword">new</span> WebSocketServer({
        port: process.env.WSPORT || <span class="number">3001</span>
    });

wss.broadcast = <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.clients) <span class="keyword">this</span>.clients[i].send(<span class="built_in">JSON</span>.stringify(data));
};

wss.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span><span class="params">(ws)</span> {</span>
    ws.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
        data = <span class="built_in">JSON</span>.parse(data);
        <span class="keyword">if</span> (data.type === <span class="string">"message"</span>) {
            wss.broadcast({
                nick: ws.nick,
                uid: ws.uid,
                time: moment(data.time).format(<span class="string">"HH:mm:ss"</span>),
                message: data.message,
                type: <span class="string">"message"</span>
            });
        } <span class="keyword">else</span> <span class="keyword">if</span> (data.type === <span class="string">"nickname"</span>) {
            wss.broadcast({
                oldnick: ws.nick,
                nick: data.nick,
                uid: ws.uid,
                type: <span class="string">"nickname"</span>
            });
            ws.nick = data.nick;
        }
    });
    ws.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        wss.broadcast({
            nick: ws.nick,
            uid: ws.uid,
            type: <span class="string">"exit"</span>
        });
    });
    ws.uid = uuid.v4();
    ws.nick = <span class="string">"游客"</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> <span class="keyword">this</span>.clients) {
        ws.send(<span class="built_in">JSON</span>.stringify({
            nick: <span class="keyword">this</span>.clients[i].nick,
            uid: <span class="keyword">this</span>.clients[i].uid,
            type: <span class="string">"join"</span>
        }));
    }
    wss.broadcast({
        nick: ws.nick,
        uid: ws.uid,
        type: <span class="string">"join"</span>
    });
});
</code></pre><h3 id="WebSocket客户端实现">WebSocket客户端实现</h3>
<hr>
<p>在浏览器中,则需要建立一个WS客户端</p>
<pre><code><span class="comment">//创建一个WS客户端</span>
<span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:3001"</span>);
</code></pre><p>给它按照WebSocket的API绑定事件:</p>
<pre><code><span class="comment">//WS客户端连接到WS服务器后, 设定默认昵称,并加入版聊</span>
ws<span class="built_in">.</span>onopen <span class="subst">=</span> function(event) {
    $(<span class="string">"#nickname"</span>)<span class="built_in">.</span>val(<span class="string">"游客"</span>);
    <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-success'&gt;您已加入版聊&lt;/div&gt;"</span>);
};
<span class="comment">//如果WS服务器关闭,给予断开提示</span>
ws<span class="built_in">.</span>onclose <span class="subst">=</span> function(event) {
    <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-danger'&gt;您已断开版聊&lt;/div&gt;"</span>);
};
<span class="comment">//如果WS服务器向这个WS客户端发送信息:</span>
ws<span class="built_in">.</span>onmessage <span class="subst">=</span> function(event) {
    <span class="built_in">var</span> <span class="built_in">data</span> <span class="subst">=</span> JSON<span class="built_in">.</span>parse(event<span class="built_in">.</span><span class="built_in">data</span>);
    <span class="comment">//发送文本信息, 显示到页面上</span>
    <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"message"</span>) {
        <span class="variable">$chat.append</span>(<span class="string">"&lt;p&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"("</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>time <span class="subst">+</span> <span class="string">"): "</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>message <span class="subst">+</span> <span class="string">"&lt;/p&gt;"</span>);
    <span class="comment">//有新用户加入, 显示用户加入通知, 并修改当前用户列表</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"join"</span>) {
        <span class="keyword">if</span> ($(<span class="string">"p[uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"']"</span>, <span class="variable">$users</span>)<span class="built_in">.</span>length <span class="subst">===</span> <span class="number">0</span>) {
            <span class="variable">$users.append</span>(<span class="string">"&lt;p uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"&lt;/p&gt;"</span>);
            <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-warning'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"加入了版聊&lt;/div&gt;"</span>);
        }
    <span class="comment">//有用户离开, 显示用户离开通知, 并修改当前用户列表</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"exit"</span>) {
        $(<span class="string">"p[uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"']"</span>, <span class="variable">$users</span>)<span class="built_in">.</span>remove();
        <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-warning'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"离开了版聊&lt;/div&gt;"</span>);
    <span class="comment">//有用户修改昵称, 显示用户修改昵称, 修改用户列表</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"nickname"</span>) {
        $(<span class="string">"#nickname"</span>)<span class="built_in">.</span>val(<span class="built_in">data</span><span class="built_in">.</span>nick);
        $(<span class="string">"p[uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"']"</span>, <span class="variable">$users</span>)<span class="built_in">.</span>text(<span class="built_in">data</span><span class="built_in">.</span>nick);
        <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-warning'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>oldnick <span class="subst">+</span> <span class="string">" 修改昵称为 "</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"&lt;/div&gt;"</span>);
    }
};
</code></pre><p>具体需要发送信息时,使用ws.send发送：</p>
<pre><code><span class="comment">//从WS客户端向WS服务器发送信息数据</span>
ws.send(<span class="built_in">JSON</span>.stringify({
    time: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),
    message: message,
    type: <span class="string">"message"</span>
}));
</code></pre><p>需要发送修改昵称请求时，采用同样的方式：</p>
<pre><code><span class="comment">//从WS客户端向WS服务器发送昵称修改请求</span>
ws.send(<span class="built_in">JSON</span>.stringify({
    nick: nick,
    type: <span class="string">"nickname"</span>
}));
</code></pre><p>这样一个完整的WS客户端代码：</p>
<pre><code><span class="comment">//创建一个WS客户端</span>
<span class="built_in">var</span> ws <span class="subst">=</span> <span class="literal">new</span> WebSocket(<span class="string">"ws://localhost:3001"</span>);
<span class="comment">//WS客户端连接到WS服务器后, 设定默认昵称,并加入版聊</span>
ws<span class="built_in">.</span>onopen <span class="subst">=</span> function(event) {
    $(<span class="string">"#nickname"</span>)<span class="built_in">.</span>val(<span class="string">"游客"</span>);
    <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-success'&gt;您已加入版聊&lt;/div&gt;"</span>);
};
<span class="comment">//如果WS服务器关闭,给予断开提示</span>
ws<span class="built_in">.</span>onclose <span class="subst">=</span> function(event) {
    <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-danger'&gt;您已断开版聊&lt;/div&gt;"</span>);
};
<span class="comment">//如果WS服务器向这个WS客户端发送信息:</span>
ws<span class="built_in">.</span>onmessage <span class="subst">=</span> function(event) {
    <span class="built_in">var</span> <span class="built_in">data</span> <span class="subst">=</span> JSON<span class="built_in">.</span>parse(event<span class="built_in">.</span><span class="built_in">data</span>);
    <span class="comment">//发送文本信息, 显示到页面上</span>
    <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"message"</span>) {
        <span class="variable">$chat.append</span>(<span class="string">"&lt;p&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"("</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>time <span class="subst">+</span> <span class="string">"): "</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>message <span class="subst">+</span> <span class="string">"&lt;/p&gt;"</span>);
    <span class="comment">//有新用户加入, 显示用户加入通知, 并修改当前用户列表</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"join"</span>) {
        <span class="keyword">if</span> ($(<span class="string">"p[uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"']"</span>, <span class="variable">$users</span>)<span class="built_in">.</span>length <span class="subst">===</span> <span class="number">0</span>) {
            <span class="variable">$users.append</span>(<span class="string">"&lt;p uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"&lt;/p&gt;"</span>);
            <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-warning'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"加入了版聊&lt;/div&gt;"</span>);
        }
    <span class="comment">//有用户离开, 显示用户离开通知, 并修改当前用户列表</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"exit"</span>) {
        $(<span class="string">"p[uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"']"</span>, <span class="variable">$users</span>)<span class="built_in">.</span>remove();
        <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-warning'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"离开了版聊&lt;/div&gt;"</span>);
    <span class="comment">//有用户修改昵称, 显示用户修改昵称, 修改用户列表</span>
    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">data</span><span class="built_in">.</span><span class="keyword">type</span> <span class="subst">===</span> <span class="string">"nickname"</span>) {
        $(<span class="string">"#nickname"</span>)<span class="built_in">.</span>val(<span class="built_in">data</span><span class="built_in">.</span>nick);
        $(<span class="string">"p[uid='"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>uid <span class="subst">+</span> <span class="string">"']"</span>, <span class="variable">$users</span>)<span class="built_in">.</span>text(<span class="built_in">data</span><span class="built_in">.</span>nick);
        <span class="variable">$logs.append</span>(<span class="string">"&lt;div class='alert alert-warning'&gt;"</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>oldnick <span class="subst">+</span> <span class="string">" 修改昵称为 "</span> <span class="subst">+</span> <span class="built_in">data</span><span class="built_in">.</span>nick <span class="subst">+</span> <span class="string">"&lt;/div&gt;"</span>);
    }
};
<span class="comment">//发送消息按钮事件</span>
$(<span class="string">"#send"</span>)<span class="built_in">.</span>click(function(event) {
    <span class="built_in">var</span> message <span class="subst">=</span> $(<span class="string">"#message"</span>)<span class="built_in">.</span>val();
    <span class="keyword">if</span> (message<span class="built_in">.</span>trim() <span class="subst">!==</span> <span class="string">""</span>) {
        <span class="comment">//从WS客户端向WS服务器发送信息数据</span>
        ws<span class="built_in">.</span>send(JSON<span class="built_in">.</span>stringify({
            time: <span class="literal">new</span> <span class="built_in">Date</span>()<span class="built_in">.</span>getTime(),
            message: message,
            <span class="keyword">type</span>: <span class="string">"message"</span>
        }));
    }
});
<span class="comment">//修改昵称按钮事件</span>
$(<span class="string">"#changeNick"</span>)<span class="built_in">.</span>click(function(event) {
    <span class="built_in">var</span> nick <span class="subst">=</span> $(<span class="string">"#nickname"</span>)<span class="built_in">.</span>val();
    <span class="keyword">if</span> (nick<span class="built_in">.</span>trim() <span class="subst">!==</span> <span class="string">""</span>) {
        <span class="comment">//从WS客户端向WS服务器发送昵称修改请求</span>
        ws<span class="built_in">.</span>send(JSON<span class="built_in">.</span>stringify({
            nick: nick,
            <span class="keyword">type</span>: <span class="string">"nickname"</span>
        }));
    }
});
</code></pre><h3 id="写在最后">写在最后</h3>
<hr>
<p>这样一个完整的基于WebSocket的简单聊天室就完成了，试用一下，虽然功能不完善，但是已经可以用了，并且兼容firefox25和chrome</p>
<hr><div class="tags"><a href="/tags/WebSocket/" class="blog-tag">WebSocket</a><a href="/tags/NodeJs/" class="blog-tag">NodeJs</a><a href="/tags/xmpp/" class="blog-tag">xmpp</a><a href="/tags/WebIM/" class="blog-tag">WebIM</a></div><hr><div class="jia"><div class="jiathis_style_32x32"><a class="jiathis_button_qzone"></a><a class="jiathis_button_tsina"></a><a class="jiathis_button_tqq"></a><a class="jiathis_button_weixin"></a><a class="jiathis_button_renren"></a><a href="http://www.jiathis.com/share?uid=1409314953297200" target="_blank" class="jiathis jiathis_txt jtico jtico_jiathis"></a></div><script type="text/javascript">var jiathis_config = {data_track_clickback:'true'};    </script><script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1409314953297200" charset="utf-8"></script></div><hr><div id="duoshuo" data-url="http://lingyu.wang/2013/12/08/websocket/" data-thread-key="/blog/2013/12/08/websocket/" data-title="搭建HTML5简易聊天室" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name:'skyinlayer'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div></article><div class="pager"><a href="/2014/01/09/clearfix/" title="闭合浮动最佳方案（clearfix）" class="pre">上一页</a></div></div><aside id="aside"><section class="recent"><h3 class="title iconfont">最新文章<i>&#xe601;</i></h3><div class="links"><ul><li><a href="/2015/05/15/react-and-webpack/">轻松入门React和Webpack</a></li><li><a href="/2015/04/26/sometalk-4-26/">4月26日杂谈</a></li><li><a href="/2015/04/18/learn-canvas-1/">前端动画对比</a></li><li><a href="/2015/01/26/18-books/">读书破万卷，敲码别走神</a></li><li><a href="/2014/11/24/7-rules-for-creating-gorgeous-ui-part-1/">构建华丽UI的7条准则（上部）</a></li></ul></div></section><section class="categories"><h3 class="title iconfont">分类<i>&#xe605;</i></h3><div class="links"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CSS/">CSS</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS技术/">JS技术</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NodeJs/">NodeJs</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端综合/">前端综合</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/即时通信/">即时通信</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/响应式/">响应式</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/思考总结/">思考总结</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/性能优化/">性能优化</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/游戏开发/">游戏开发</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔试面试/">笔试面试</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/翻译/">翻译</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">10</span></li></ul></div></section><section class="tags"><h3 class="title iconfont">标签<i>&#xe603;</i></h3><div class="links"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a><span class="tag-list-count">35</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Canvas/">Canvas</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DataChannel/">DataChannel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/">ES6</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Generator/">Generator</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gulp/">Gulp</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">29</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">39</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kissy/">Kissy</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeJs/">NodeJs</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SEO/">SEO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebIM/">WebIM</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebRTC/">WebRTC</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebSocket/">WebSocket</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grunt/">grunt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jQuery/">jQuery</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/koa/">koa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oracle/">oracle</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xmpp/">xmpp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/动画/">动画</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/响应式/">响应式</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/存储函数/">存储函数</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/思考/">思考</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/游戏/">游戏</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/生活/">生活</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/笔试面试题/">笔试面试题</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计/">设计</a><span class="tag-list-count">10</span></li></ul></div></section><section class="archives"><h3 class="title iconfont"> 归档<i>&#xe60a;</i></h3><div class="links"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05">2015年5月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04">2015年4月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01">2015年1月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11">2014年11月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10">2014年10月</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09">2014年9月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07">2014年7月</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05">2014年5月</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04">2014年4月</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03">2014年3月</a><span class="archive-list-count">29</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02">2014年2月</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/01">2014年1月</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12">2013年12月</a><span class="archive-list-count">1</span></li></ul></div></section></aside></section><footer id="page-footer"><span style="float:right"><script type="text/javascript">var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fa5aa4945a04cc5a5a4cd6835ccb7d419' type='text/javascript'%3E%3C/script%3E"));</script></span><p>&copy;Powered by<a href="http://hexo.io" target="_blank" title="hexo">&nbsp;hexo&nbsp;</a>and Theme by<a href="https://github.com/LingyuCoder/lingyu-theme">&nbsp;LingyuCoder</a></p></footer><canvas id="snow"></canvas><style type="text/css">#snow {
    position: fixed;
    display: block;
    pointer-events: none;
    top: 0;
    left: 0;
}
</style><script type="text/javascript" src="/scripts/snow.js"></script><script type="text/javascript">var snow = new Snow('snow', {
    'amount': 10,
    'size': [8, 20],
    'rotation': [1, 5],
    'speed': [40, 80],
    'swing': [0.1, 1],
    'amplitude': [30, 50],
    'alpha': [0.1, 0.95],
    'images': [
        'http://skyinlayerblog.qiniudn.com/blog/img/snow_1.png',
        'http://skyinlayerblog.qiniudn.com/blog/img/snow_2.png',
        'http://skyinlayerblog.qiniudn.com/blog/img/snow_3.png',
        'http://skyinlayerblog.qiniudn.com/blog/img/snow_4.png'
    ]
});

window.addEventListener('resize', function() {
    snow.resize(window.innerWidth, window.innerHeight);
}, false);

window.addEventListener('load', function() {
    snow.start();
}, false);</script><script type="text/javascript" src="http://cdn.staticfile.org/jquery/2.1.1-rc2/jquery.min.js"></script><script type="text/javascript">$(function(){
    var duoshuoIds = [];
    var map = {};
    $('.meta').each(function(){
        var $this = $(this);
        var id = $this.attr('thread');
        duoshuoIds.push(id);
        map[id] = $this;
    });
    duoshuoIds.length && $.ajax({
        url: 'http://api.duoshuo.com/threads/counts.jsonp',
        data: {
            threads: duoshuoIds.join(','),
            short_name: 'skyinlayer'
        },
        success: function(data){
            $.each(data.response, function(key, value){
                var $el = map[key];
                if($el) {
                    $.each(['comments','likes', 'reposts'], function(index, type){
                        $el.find('.' + type).append('<span>' + value[type] + '</span>');
                    });
                }
            });
        },
        dataType: 'jsonp'
    });
});</script></body></html>