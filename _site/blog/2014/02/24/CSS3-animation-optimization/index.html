<!DOCTYPE HTML>
<html lang="zh">
	<head>
		<title>如何让CSS3的动画不再卡顿失帧？ - 天镶的博客 SkyInlayer`s Blog </title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta http-equiv="cache-control" content="max-age=0"/>
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700|Open+Sans+Condensed:300,700" rel="stylesheet" />
		<noscript>
			<link rel="stylesheet" href="/css/skel-noscript.min.css" />
		</noscript>
		<link rel="stylesheet" href="/css/style.min.css" />
		<link rel="stylesheet" href="/css/style-desktop.min.css" />
		<link rel="stylesheet" href="/css/style-wide.min.css" />
		<link rel="stylesheet" href="/css/github.min.css" />
		<script src="/js/jquery.min.js"></script>
	</head>
	<body class="left-sidebar">
		<div id="wrapper">
			<div id="content">
				<div id="content-inner">
					<article class="is-post is-post-excerpt">
						<header>
							<h2><a href="#">如何让CSS3的动画不再卡顿失帧？</a></h2>
							<span class="byline">编写高性能的CSS3动画</span>
							<div class="tags">
								
									<a class="tag" href="/show_by_tag.html?tag=css" class="tag">css</a>
								
							</div>
						</header>
						<div class="info">
							<span class='date'><span class='month'>Feb</span><span class='day'>24</span><span class='year'>2014</span></span>
						</div>
						<p>最近拜读了一下<a href="http://www.html5rocks.com/">html5rocks</a>上几位大神写的一篇关于CSS3动画性能优化的文章，学到了很多，在这里记录一下，其中的知识都是来源于那篇文章，我只是截取了其中比较关注的内容出来，原文地址<a href="http://www.html5rocks.com/en/tutorials/speed/high-performance-animations/">High Performance Animations</a></p>

<h2 id="">原理</h2>

<p>现代浏览器在使用CSS3动画时，以下四种情形绘制的效率较高，分别是：</p>

<ul>
<li>改变位置</li>

<li>改变大小</li>

<li>旋转</li>

<li>改变透明度</li>
</ul>

<p>一次动画帧浏览器需要做如下工作：</p>

<ol>
<li>计算需要被加载到节点上的样式结果（Recalculate style）</li>

<li>为每个节点生成图形和位置（Layout）</li>

<li>将每个节点填充到图层中（Paint Setup和Paint）</li>

<li>组合图层到页面上（Composite Layers）</li>
</ol>

<p>如果我们需要使得动画的性能提高，需要做的就是减少浏览器在动画运行时所需要做的工作。最好的情况是，改变的属性仅仅印象图层的组合，变换（<code>transform</code>）和透明度（<code>opacity</code>）就属于这种情况</p>

<p>现代浏览器如Chrome，Firefox，Safari和Opera都对变换和透明度采用硬件加速，但IE10+不是很确定是否硬件加速</p>

<h2 id="_2">触发重布局的属性</h2>

<p>有些节点，当你改变他时，会需要重新布局（这也意味着需要重新计算其他被影响的节点的位置和大小）。这种情况下，被影响的DOM树越大（可见节点），重绘所需要的时间就会越长，而渲染一帧动画的时间也相应变长。所以需要尽力避免这些属性</p>

<p>一些常用的改变时会触发重布局的属性： 盒子模型相关属性会触发重布局：</p>

<ul>
<li>width</li>

<li>height</li>

<li>padding</li>

<li>margin</li>

<li>display</li>

<li>border-width</li>

<li>border</li>

<li>min-height</li>
</ul>

<p>定位属性及浮动也会触发重布局：</p>

<ul>
<li>top</li>

<li>bottom</li>

<li>left</li>

<li>right</li>

<li>position</li>

<li>float</li>

<li>clear</li>
</ul>

<p>改变节点内部文字结构也会触发重布局：</p>

<ul>
<li>text-align</li>

<li>overflow-y</li>

<li>font-weight</li>

<li>overflow</li>

<li>font-family</li>

<li>line-height</li>

<li>vertival-align</li>

<li>white-space</li>

<li>font-size</li>
</ul>

<p>这么多常用属性都会触发重布局，可以看到，他们的特点就是可能修改整个节点的大小或位置，所以会触发重布局</p>

<h3 id="css">别使用CSS类名做状态标记</h3>

<p>如果在网页中使用CSS的类来对节点做状态标记，当这些节点的状态标记类修改时，将会触发节点的重绘和重布局。所以在节点上使用CSS类来做状态比较是代价很昂贵的</p>

<h2 id="_3">触发重绘的属性</h2>

<p>修改时只触发重绘的属性有：</p>

<ul>
<li>color</li>

<li>border-style</li>

<li>border-radius</li>

<li>visibility</li>

<li>text-decoration</li>

<li>background</li>

<li>background-image</li>

<li>background-position</li>

<li>background-repeat</li>

<li>background-size</li>

<li>outline-color</li>

<li>outline</li>

<li>outline-style</li>

<li>outline-width</li>

<li>box-shadow</li>
</ul>

<p>这样可以看到，这些属性都不会修改节点的大小和位置，自然不会触发重布局，但是节点内部的渲染效果进行了改变，所以只需要重绘就可以了</p>

<h3 id="_4">手机就算重绘也很慢</h3>

<p>在重绘时，这些节点会被加载到GPU中进行重绘，这对移动设备如手机的影响还是很大的。因为CPU不如台式机或笔记本电脑，所以绘画巫妖的时间更长。而且CPU与GPU之间的有较大的带宽限制，所以纹理的上传需要一定时间</p>

<h2 id="_5">触发图层重组的属性</h2>

<h3 id="_6">透明度竟然不会触发重绘？</h3>

<p>需要注意的是，上面那些触发重绘的属性里面没有<code>opacity</code>（透明度），很奇怪不是吗？实际上透明度的改变后，GPU在绘画时只是简单的降低之前已经画好的纹理的alpha值来达到效果，并不需要整体的重绘。不过这个前提是这个被修改<code>opacity</code>本身必须是一个图层，如果图层下还有其他节点，GPU也会将他们透明化</p>

<h3 id="_7">强迫浏览器创建图层</h3>

<p>在Blink和WebKit的浏览器中，一当一个节点被设定了透明度的相关过渡效果或动画时，浏览器会将其作为一个单独的图层，但很多开发者使用<code>translateZ(0)</code>或者<code>translate3d(0,0,0)</code>去使浏览器创建图层。这种方式可以消除在动画开始之前的图层创建时间，使得动画尽快开始（创建图层和绘制图层还是比较慢的），而且不会随着抗锯齿而导出突变。不过这种方法需要节制，否则会因为创建过多的图层导致崩溃</p>

<h3 id="chrome">Chrome中的抗锯齿</h3>

<p>Chrome中，非根图层以及透明图层使用grayscale antialiasing而不是subpixel antialiasing，如果抗锯齿方法变化，这个效果将会非常显著。如果你打算预处理一个节点而不打算等到动画开始，可以通过这种强迫浏览器创建图层的方式进行</p>

<h3 id="transform">transform变换是你的选择</h3>

<p>我们通过节点的<code>transform</code>可以修改节点的位置、旋转、大小等。我们平常会使用<code>left</code>和<code>top</code>属性来修改节点的位置，但正如上面所述，<code>left</code>和<code>top</code>会触发重布局，修改时的代价相当大。取而代之的更好方法是使用<code>translate</code>，这个不会触发重布局</p>

<h2 id="jscss3">JS动画和CSS3动画的比较</h2>

<p>我们经常面临一个抉择：是使用JavaScript的动画还是使用CSS的动画，下面将对比一下这两种方式</p>

<h3 id="js">JS动画</h3>

<p>缺点：JavaScript在浏览器的主线程中运行，而其中还有很多其他需要运行的JavaScript、样式计算、布局、绘制等对其干扰。这也就导致了线程可能出现阻塞，从而造成丢帧的情况。</p>

<p>优点：JavaScript的动画与CSS预先定义好的动画不同，可以在其动画过程中对其进行控制：开始、暂停、回放、中止、取消都是可以做到的。而且一些动画效果，比如视差滚动效果，只有JavaScript能够完成</p>

<h3 id="css_2">CSS动画</h3>

<p>缺点：缺乏强大的控制能力。而且很难以有意义的方式结合到一起，使得动画变得复杂且易于出问题。 优点：浏览器可以对动画进行优化。它必要时可以创建图层，然后在主线程之外运行。</p>

<h2 id="_8">前瞻</h2>

<p>Google目前正在探究通过JS的多线程（Web Workers）来提供更好的动画效果，而不会触发重布局及样式重计算</p>

<h2 id="_9">结论</h2>

<p>动画给予了页面丰富的视觉体验。我们应该尽力避免使用会触发重布局和重绘的属性，以免失帧。最好提前申明动画，这样能让浏览器提前对动画进行优化。由于GPU的参与，现在用来做动画的最好属性是如下几个：</p>

<ul>
<li>opacity</li>

<li>translate</li>

<li>rotate</li>

<li>scale</li>
</ul>

<p>也许会有一些新的方式使得可以使用JavaScript做出更好的没有限制的动画，而且不用担心主线程的阻塞问题。但在那之前，还是好好考虑下如何做出流畅的动画吧</p>
						<div class="ds-thread" data-url="http://skyinlayer.com//blog/2014/02/24/CSS3-animation-optimization" data-thread-key="/blog/2014/02/24/CSS3-animation-optimization" data-title="如何让CSS3的动画不再卡顿失帧？" style="min-height:277px"></div>
					</article>
				</div>
			</div>
			<div id="sidebar">
				<a href="/" style="text-decoration: none;">
	<div id="logo">
		<h1>SkyInlayer</h1>
	</div>
</a>
<nav id="nav">
	<ul>
		<li class=""><a href="/index.html">首页</a></li>
		<li class=""><a href="/archieves.html">所有文章</a></li>
		<li class=" no_wide_hide"><a href="/items.html">小玩意儿</a></li>
		<li class=""><a href="/about.html">关于我</a></li>
		<li><a href="/profile.html">个人简历</a></li>
	</ul>
</nav>
<section class="is-recent-posts">
	<header>
		<h2>最近的文章</h2>
	</header>
	<ul>
		
		<li><a href="/blog/2014/02/24/CSS3-animation-optimization">如何让CSS3的动画不再卡顿失帧？</a>24 Feb 2014</li>
		
		<li><a href="/blog/2014/02/20/application-cache">使用应用缓存构建离线应用</a>20 Feb 2014</li>
		
		<li><a href="/blog/2014/02/19/plsql-and-storage-function">PL/SQL编写存储函数</a>19 Feb 2014</li>
		
		<li><a href="/blog/2014/02/15/responsive-html5">聊聊响应式网页设计中的HTML5</a>15 Feb 2014</li>
		
		<li><a href="/blog/2014/02/14/responsive-web-design">聊聊响应式网页设计</a>14 Feb 2014</li>
		
	</ul>
</section>
<section class="is-recent-posts">
	<header>
		<h2>文章类别</h2>
	</header>
	<ul>
		
		<li><a href="/show_by_category.html?cat=网站建设">网站建设</a>6</li>
		
		<li><a href="/show_by_category.html?cat=前端技术">前端技术</a>9</li>
		
		<li><a href="/show_by_category.html?cat=生活情感">生活情感</a>2</li>
		
		<li><a href="/show_by_category.html?cat=数据库技术">数据库技术</a>1</li>
		
	</ul>
</section>
<section class="is-recent-posts">
	<header>
		<h2>文章标签</h2>
	</header>
	<div class="tags">
		
		<a class="tag" href="/show_by_tag.html?tag=WebSocket"> WebSocket</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=NodeJs"> NodeJs</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=xmpp"> xmpp</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=WebIM"> WebIM</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=css"> css</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=github"> github</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=jekyll"> jekyll</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=jQuery"> jQuery</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=JavaScript"> JavaScript</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=生活"> 生活</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=思考"> 思考</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=HTML"> HTML</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=CSS"> CSS</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=响应式"> 响应式</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=oracle"> oracle</a>
	    
		<a class="tag" href="/show_by_tag.html?tag=存储函数"> 存储函数</a>
	    
	</div>
</section>
<div id="copyright">
	<p>&copy; 2014 天镶<br /></p>
</div>
			</div>
		</div>
		<!-- Duoshuo Comment BEGIN -->
		<script type="text/javascript">
			var duoshuoQuery = {short_name:"skyinlayer"};
			(function() {
				var ds = document.createElement('script');
				ds.type = 'text/javascript';ds.async = true;
				ds.src = 'http://static.duoshuo.com/embed.js';
				ds.charset = 'UTF-8';
				(document.getElementsByTagName('head')[0] 
				|| document.getElementsByTagName('body')[0]).appendChild(ds);
			})();
		</script>
		<!-- Duoshuo Comment END -->
		<script src="/js/skel.min.js"></script>
		<script src="/js/skel-panels.min.js"></script>
		<script src="/js/highlight.pack.js"></script>
		<script src="/js/init.min.js"></script>
	</body>
</html>